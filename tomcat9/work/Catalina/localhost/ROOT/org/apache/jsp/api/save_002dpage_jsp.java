/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/9.0.91
 * Generated at: 2025-08-06 06:31:05 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp.api;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import java.io.*;
import java.util.*;
import java.net.URLDecoder;
import com.google.gson.*;
import java.io.*;
import java.util.*;
import java.nio.file.*;
import java.nio.charset.StandardCharsets;
import com.google.gson.*;
import java.text.SimpleDateFormat;

public final class save_002dpage_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports {


/**
 * CMS ì½˜í…ì¸  ì €ì¥ì„ ìœ„í•œ íŒŒì¼ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤
 * JSP ë‚´ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì •ì  ë©”ì„œë“œë“¤ì„ ì œê³µ
 */
public class FileUtils {
    
    private final String GENERATED_CONTENT_PATH = "generated-content";
    private final String ENCODING = "UTF-8";
    private final Gson gson = new GsonBuilder().setPrettyPrinting().create();
    
    /**
     * ì‚¬ì´íŠ¸ í´ë” ê²½ë¡œ ìƒì„±
     */
    public String getSitePath(ServletContext context, String siteId) {
        String basePath = context.getRealPath("/");
        return basePath + File.separator + GENERATED_CONTENT_PATH + File.separator + siteId;
    }
    
    /**
     * ë©”ë‰´ ì½˜í…ì¸  í´ë” ê²½ë¡œ ìƒì„±
     */
    public String getContentPath(ServletContext context, String siteId, String menuId, String submenuId) {
        String sitePath = getSitePath(context, siteId);
        return sitePath + File.separator + menuId + File.separator + submenuId;
    }
    
    /**
     * í´ë” ìƒì„± (ì¬ê·€ì )
     */
    public boolean createDirectories(String path) {
        try {
            File directory = new File(path);
            if (!directory.exists()) {
                return directory.mkdirs();
            }
            return true;
        } catch (Exception e) {
            System.err.println("ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + path + " - " + e.getMessage());
            return false;
        }
    }
    
    /**
     * í…ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥
     */
    public  boolean saveTextFile(String filePath, String content) {
        try {
            File file = new File(filePath);
            File parentDir = file.getParentFile();
            if (parentDir != null && !parentDir.exists()) {
                parentDir.mkdirs();
            }
            
            try (FileWriter writer = new FileWriter(file, StandardCharsets.UTF_8)) {
                writer.write(content);
                return true;
            }
        } catch (Exception e) {
            System.err.println("íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + filePath + " - " + e.getMessage());
            return false;
        }
    }
    
    /**
     * í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸°
     */
    public String readTextFile(String filePath) {
        try {
            File file = new File(filePath);
            if (!file.exists()) {
                return null;
            }
            
            StringBuilder content = new StringBuilder();
            try (BufferedReader reader = new BufferedReader(new FileReader(file, StandardCharsets.UTF_8))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    content.append(line).append("\n");
                }
            }
            return content.toString();
        } catch (Exception e) {
            System.err.println("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: " + filePath + " - " + e.getMessage());
            return null;
        }
    }
    
    /**
     * JSON íŒŒì¼ ì €ì¥
     */
    public  boolean saveJsonFile(String filePath, Object data) {
        try {
            String jsonContent = gson.toJson(data);
            return saveTextFile(filePath, jsonContent);
        } catch (Exception e) {
            System.err.println("JSON íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + filePath + " - " + e.getMessage());
            return false;
        }
    }
    
    /**
     * JSON íŒŒì¼ ì½ê¸°
     */
    public   Map<String, Object> readJsonFile(String filePath) {
        try {
            String content = readTextFile(filePath);
            if (content == null || content.trim().isEmpty()) {
                return null;
            }
            
            return gson.fromJson(content, Map.class);
        } catch (Exception e) {
            System.err.println("JSON íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: " + filePath + " - " + e.getMessage());
            return null;
        }
    }
    
    /**
     * ì‚¬ì´íŠ¸ ì •ë³´ ê°ì²´ ìƒì„±
     */
    public   Map<String, Object> createSiteInfo(String siteId, String siteName, String domain) {
        Map<String, Object> siteInfo = new HashMap<>();
        siteInfo.put("siteId", siteId);
        siteInfo.put("siteName", siteName);
        siteInfo.put("domain", domain);
        siteInfo.put("theme", "academic");
        siteInfo.put("language", "ko");
        siteInfo.put("createdAt", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(new Date()));
        siteInfo.put("lastUpdated", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(new Date()));
        return siteInfo;
    }
    
    /**
     * ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ê°ì²´ ìƒì„±
     */
    public   Map<String, Object> createContentMetadata(String pageId, String title, String subtitle, 
                                                           String mainContent, String features, double processingTime) {
        Map<String, Object> metadata = new HashMap<>();
        metadata.put("pageId", pageId);
        metadata.put("timestamp", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(new Date()));
        
        // ì½˜í…ì¸  ì •ë³´
        Map<String, Object> content = new HashMap<>();
        content.put("title", title);
        content.put("subtitle", subtitle);
        content.put("mainContent", parseJsonArray(mainContent));
        content.put("features", parseJsonArray(features));
        content.put("images", new ArrayList<>());
        content.put("metadata", new HashMap<>());
        metadata.put("content", content);
        
        // ìƒì„± ì •ë³´
        Map<String, Object> generationInfo = new HashMap<>();
        generationInfo.put("model", "gpt-4");
        generationInfo.put("processingTime", processingTime);
        generationInfo.put("wordCount", calculateWordCount(title, subtitle, mainContent, features));
        metadata.put("generationInfo", generationInfo);
        
        return metadata;
    }
    
    /**
     * JSON ë°°ì—´ ë¬¸ìì—´ì„ Listë¡œ íŒŒì‹±
     */
    private      List<Object> parseJsonArray(String jsonStr) {
        try {
            if (jsonStr == null || jsonStr.trim().isEmpty()) {
                return new ArrayList<>();
            }
            return gson.fromJson(jsonStr, List.class);
        } catch (Exception e) {
            // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë‹¨ìˆœ ë¬¸ìì—´ë¡œ ì²˜ë¦¬
            List<Object> result = new ArrayList<>();
            result.add(jsonStr);
            return result;
        }
    }
    
    /**
     * ë‹¨ì–´ ìˆ˜ ê³„ì‚°
     */
    private int calculateWordCount(String title, String subtitle, String mainContent, String features) {
        int totalChars = 0;
        
        if (title != null) totalChars += title.length();
        if (subtitle != null) totalChars += subtitle.length();
        if (mainContent != null) totalChars += mainContent.length();
        if (features != null) totalChars += features.length();
        
        return totalChars;
    }
    
    /**
     * íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
     */
    public boolean fileExists(String filePath) {
        return new File(filePath).exists();
    }
    
    /**
     * í´ë” ë‚´ ëª¨ë“  ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ
     */
    public   List<String> listSites(ServletContext context) {
        List<String> sites = new ArrayList<>();
        try {
            String basePath = context.getRealPath("/") + File.separator + GENERATED_CONTENT_PATH;
            File baseDir = new File(basePath);
            
            if (baseDir.exists() && baseDir.isDirectory()) {
                File[] siteDirs = baseDir.listFiles(File::isDirectory);
                if (siteDirs != null) {
                    for (File siteDir : siteDirs) {
                        sites.add(siteDir.getName());
                    }
                }
            }
        } catch (Exception e) {
            System.err.println("ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
        }
        return sites;
    }
    
    /**
     * ì‚¬ì´íŠ¸ ë‚´ ë©”ë‰´ ëª©ë¡ ì¡°íšŒ
     */
    public List<String> listMenus(ServletContext context, String siteId) {
        List<String> menus = new ArrayList<>();
        try {
            String sitePath = getSitePath(context, siteId);
            File siteDir = new File(sitePath);
            
            if (siteDir.exists() && siteDir.isDirectory()) {
                File[] menuDirs = siteDir.listFiles(file -> 
                    file.isDirectory() && !file.getName().equals("site-info.json")
                );
                if (menuDirs != null) {
                    for (File menuDir : menuDirs) {
                        menus.add(menuDir.getName());
                    }
                }
            }
        } catch (Exception e) {
            System.err.println("ë©”ë‰´ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
        }
        return menus;
    }
    
    /**
     * ì‘ë‹µ JSON ìƒì„± (ì„±ê³µ)
     */
    public   String createSuccessResponse(String message, Object data) {
        Map<String, Object> response = new HashMap<>();
        response.put("success", true);
        response.put("message", message);
        response.put("data", data);
        response.put("timestamp", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(new Date()));
        return gson.toJson(response);
    }
    
    /**
     * ì‘ë‹µ JSON ìƒì„± (ì‹¤íŒ¨)
     */
    public   String createErrorResponse(String message, String error) {
        Map<String, Object> response = new HashMap<>();
        response.put("success", false);
        response.put("message", message);
        response.put("error", error);
        response.put("timestamp", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(new Date()));
        return gson.toJson(response);
    }
    
    /**
     * ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„± (íŠ¹ìˆ˜ë¬¸ì ì œê±°)
     */
    public  String sanitizeFileName(String fileName) {
        if (fileName == null) return "untitled";
        return fileName.replaceAll("[^a-zA-Z0-9ê°€-í£._-]", "_");
    }
    
    /**
     * í´ë” í¬ê¸° ê³„ì‚° (ë°”ì´íŠ¸)
     */
    public   long calculateDirectorySize(String dirPath) {
        try {
            File directory = new File(dirPath);
            return Files.walk(directory.toPath())
                    .filter(Files::isRegularFile)
                    .mapToLong(path -> {
                        try {
                            return Files.size(path);
                        } catch (Exception e) {
                            return 0L;
                        }
                    })
                    .sum();
        } catch (Exception e) {
            return 0L;
        }
    }
    
    /**
     * ë°ì´í„° ë² ì´ìŠ¤ ê²½ë¡œ ìƒì„± (/data/)
     * JSP API íŒŒì¼ë“¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” í†µí•© ë°ì´í„° ì €ì¥ ê²½ë¡œ
     */
    public String getDataBasePath(ServletContext application) {
        String basePath = application.getRealPath("/");
        return basePath + File.separator + "data";
    }
}

// FileUtils ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
FileUtils fileUtils = new FileUtils();


  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  static {
    _jspx_dependants = new java.util.HashMap<java.lang.String,java.lang.Long>(1);
    _jspx_dependants.put("/api/utils/FileUtils.jsp", Long.valueOf(1754455268926L));
  }

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.LinkedHashSet<>(10);
    _jspx_imports_packages.add("javax.servlet");
    _jspx_imports_packages.add("java.util");
    _jspx_imports_packages.add("javax.servlet.http");
    _jspx_imports_packages.add("java.io");
    _jspx_imports_packages.add("javax.servlet.jsp");
    _jspx_imports_packages.add("com.google.gson");
    _jspx_imports_packages.add("java.nio.file");
    _jspx_imports_classes = new java.util.LinkedHashSet<>(4);
    _jspx_imports_classes.add("java.net.URLDecoder");
    _jspx_imports_classes.add("java.text.SimpleDateFormat");
    _jspx_imports_classes.add("java.nio.charset.StandardCharsets");
  }

  private volatile javax.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public javax.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {

    if (!javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      final java.lang.String _jspx_method = request.getMethod();
      if ("OPTIONS".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        return;
      }
      if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPë“¤ì€ ì˜¤ì§ GET, POST ë˜ëŠ” HEAD ë©”ì†Œë“œë§Œì„ í—ˆìš©í•©ë‹ˆë‹¤. JasperëŠ” OPTIONS ë©”ì†Œë“œ ë˜í•œ í—ˆìš©í•©ë‹ˆë‹¤.");
        return;
      }
    }

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("application/json; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write('\n');
      out.write('\n');
      out.write('\n');
      out.write("\n");
      out.write("\n");
      out.write("\n");
      out.write("\n");
      out.write("\n");
      out.write("\n");
      out.write('\n');
      out.write('\n');

// UTF-8 ì¸ì½”ë”© ê°•ì œ ì„¤ì •
request.setCharacterEncoding("UTF-8");
response.setCharacterEncoding("UTF-8");

      out.write('\n');
      out.write('\n');

/**
 * CMS AI ê°œë³„ í˜ì´ì§€ ì €ì¥ API
 * JSPContentStorage.storeGeneratedContent()ì™€ ì—°ë™
 * POST ìš”ì²­ìœ¼ë¡œ ê°œë³„ í˜ì´ì§€ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥
 * 
 * Parameters:
 * - siteId: ì‚¬ì´íŠ¸ ê³ ìœ  ID (ê¸°ë³¸ê°’: ewha)
 * - menuId: ë©”ë‰´ ID  
 * - submenuId: ì„œë¸Œë©”ë‰´ ID
 * - pageData: í˜ì´ì§€ ë°ì´í„° JSON (title, subtitle, mainContent, features, cmsContentHTML ë“±)
 */

response.setContentType("application/json; charset=UTF-8");
response.setHeader("Access-Control-Allow-Origin", "*");
response.setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS");
response.setHeader("Access-Control-Allow-Headers", "Content-Type");

// OPTIONS ìš”ì²­ ì²˜ë¦¬ (CORS preflight)
if ("OPTIONS".equals(request.getMethod())) {
    response.setStatus(HttpServletResponse.SC_OK);
    return;
}

try {
    // POST ìš”ì²­ë§Œ í—ˆìš©
    if (!"POST".equals(request.getMethod())) {
        out.print(fileUtils.createErrorResponse("ì˜ëª»ëœ ìš”ì²­ ë°©ì‹", "POST ìš”ì²­ë§Œ í—ˆìš©ë©ë‹ˆë‹¤."));
        return;
    }
    
    // íŒŒë¼ë¯¸í„° ìˆ˜ì§‘ ë° ë””ë²„ê¹…
    String siteId = request.getParameter("siteId");
    String menuId = request.getParameter("menuId");
    String submenuId = request.getParameter("submenuId");
    String pageDataJson = request.getParameter("pageData");
    
    // ë””ë²„ê¹…: ë°›ì€ íŒŒë¼ë¯¸í„° ë¡œê·¸
    System.out.println("ğŸ“¥ JSP ë°›ì€ íŒŒë¼ë¯¸í„°:");
    System.out.println("- siteId: " + siteId);
    System.out.println("- menuId: " + menuId);
    System.out.println("- submenuId: " + submenuId);
    System.out.println("- pageDataJson length: " + (pageDataJson != null ? pageDataJson.length() : "null"));
    
    // ëª¨ë“  íŒŒë¼ë¯¸í„° ì´ë¦„ ì¶œë ¥
    java.util.Enumeration<String> paramNames = request.getParameterNames();
    System.out.println("- ëª¨ë“  íŒŒë¼ë¯¸í„°: ");
    while (paramNames.hasMoreElements()) {
        String paramName = paramNames.nextElement();
        System.out.println("  * " + paramName + " = " + request.getParameter(paramName));
    }
    
    // ê¸°ë³¸ê°’ ì„¤ì •
    if (siteId == null || siteId.trim().isEmpty()) {
        siteId = "ewha";
    }
    
    // í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦
    if (menuId == null || menuId.trim().isEmpty()) {
        out.print(fileUtils.createErrorResponse("í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½", "menuIdê°€ í•„ìš”í•©ë‹ˆë‹¤."));
        return;
    }
    
    if (submenuId == null || submenuId.trim().isEmpty()) {
        out.print(fileUtils.createErrorResponse("í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½", "submenuIdê°€ í•„ìš”í•©ë‹ˆë‹¤."));
        return;
    }
    
    if (pageDataJson == null || pageDataJson.trim().isEmpty()) {
        out.print(fileUtils.createErrorResponse("í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½", "pageDataê°€ í•„ìš”í•©ë‹ˆë‹¤."));
        return;
    }
    
    // URLSearchParamsë¡œ ì „ì†¡ëœ ë°ì´í„°ëŠ” ì´ë¯¸ ë””ì½”ë”©ë¨ - URLDecoder ì œê±°
    // ë””ì½”ë”© ë‹¨ê³„ ì œê±°í•˜ì—¬ ì´ì¤‘ ë””ì½”ë”© ë¬¸ì œ ë°©ì§€
    
    // ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±
    siteId = fileUtils.sanitizeFileName(siteId);
    menuId = fileUtils.sanitizeFileName(menuId);
    submenuId = fileUtils.sanitizeFileName(submenuId);
    
    // JSON ë°ì´í„° íŒŒì‹±
    Gson gson = new Gson();
    Map<String, Object> pageData;
    try {
        pageData = gson.fromJson(pageDataJson, Map.class);
    } catch (Exception e) {
        out.print(fileUtils.createErrorResponse("JSON íŒŒì‹± ì˜¤ë¥˜", "pageData JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: " + e.getMessage()));
        return;
    }
    
    // 1. ë°ì´í„° í´ë” ìƒì„± (/data/siteId/menuId/)
    String dataBasePath = fileUtils.getDataBasePath(application);
    String siteDataPath = dataBasePath + File.separator + siteId;
    String menuDataPath = siteDataPath + File.separator + menuId;
    
    if (!fileUtils.createDirectories(menuDataPath)) {
        out.print(fileUtils.createErrorResponse("í´ë” ìƒì„± ì‹¤íŒ¨", "ë°ì´í„° í´ë”ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + menuDataPath));
        return;
    }
    
    // 2. í˜ì´ì§€ JSON íŒŒì¼ ì €ì¥ (submenuId.json)
    String pageJsonPath = menuDataPath + File.separator + submenuId + ".json";
    
    // ë©”íƒ€ë°ì´í„° ì¶”ê°€
    pageData.put("pageId", menuId + "/" + submenuId);
    pageData.put("siteId", siteId);
    pageData.put("menuId", menuId);
    pageData.put("submenuId", submenuId);
    
    // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
    Map<String, Object> metadata = (Map<String, Object>) pageData.get("metadata");
    if (metadata == null) {
        metadata = new HashMap<>();
        pageData.put("metadata", metadata);
    }
    metadata.put("savedAt", new java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(new Date()));
    metadata.put("version", ((Number) metadata.getOrDefault("version", 0)).intValue() + 1);
    
    // JSON íŒŒì¼ ì €ì¥
    if (!fileUtils.saveJsonFile(pageJsonPath, pageData)) {
        out.print(fileUtils.createErrorResponse("í˜ì´ì§€ ì €ì¥ ì‹¤íŒ¨", "í˜ì´ì§€ JSON íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
        return;
    }
    
    // 3. ì‚¬ì´íŠ¸ ì •ë³´ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ (ì—†ëŠ” ê²½ìš°ë§Œ)
    String siteInfoPath = siteDataPath + File.separator + "site-info.json";
    if (!fileUtils.fileExists(siteInfoPath)) {
        Map<String, Object> siteInfo = fileUtils.createSiteInfo(siteId, "ì´í™”ì—¬ìëŒ€í•™êµ", "ewha.ac.kr");
        fileUtils.saveJsonFile(siteInfoPath, siteInfo);
    }
    
    // 4. ì„±ê³µ ì‘ë‹µ ìƒì„±
    Map<String, Object> responseData = new HashMap<>();
    responseData.put("siteId", siteId);
    responseData.put("menuId", menuId);
    responseData.put("submenuId", submenuId);
    responseData.put("pageId", menuId + "/" + submenuId);
    responseData.put("filePath", pageJsonPath);
    responseData.put("fileSize", new File(pageJsonPath).length());
    responseData.put("version", metadata.get("version"));
    
    // ì €ì¥ëœ ì½˜í…ì¸  ì •ë³´
    Map<String, Object> contentInfo = new HashMap<>();
    contentInfo.put("title", pageData.get("title"));
    contentInfo.put("subtitle", pageData.get("subtitle"));
    contentInfo.put("hasMainContent", pageData.get("mainContent") != null);
    contentInfo.put("hasFeatures", pageData.get("features") != null);
    contentInfo.put("hasCmsContentHTML", pageData.get("cmsContentHTML") != null);
    responseData.put("contentInfo", contentInfo);
    
    out.print(fileUtils.createSuccessResponse("í˜ì´ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", responseData));
    
} catch (Exception e) {
    // ì˜ˆì™¸ ì²˜ë¦¬
    StringWriter sw = new StringWriter();
    PrintWriter pw = new PrintWriter(sw);
    e.printStackTrace(pw);
    String stackTrace = sw.toString();
    
    System.err.println("save-page.jsp ì˜¤ë¥˜: " + e.getMessage());
    System.err.println("Stack trace: " + stackTrace);
    
    out.print(fileUtils.createErrorResponse("ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜", 
        "í˜ì´ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage()));
}

    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
